<!DOCTYPE html>
<!-- saved from url=(0114)https://0xc4t.github.io/content.html?p=md/esc2-ad-cs-misconfigurations-exploitation-active-airectory-pentesting.md -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESC2 ADCS Misconfigurations exploitation — Active Directory Pentesting</title>
    <meta property="og:type" content="website">
    <meta property="og:title" content="ESC2 ADCS Misconfigurations exploitation — Active Directory Pentesting">
    <meta property="og:description" content="ESC2 (Escalation Path 2) is a vulnerability in Active Directory Certificate Services where a certificate template allows low-privileged users to enroll and include dangerous Extended Key Usages (EKUs)">
    <meta property="og:site_name" content="0xc4t Posts">
    <meta property="og:image" content="https://miro.medium.com/v2/resize:fit:720/format:webp/1*WMaw8ipMdNBtsrDT4bd2CQ.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <link rel="stylesheet" href="../../style.css">
    <link rel="icon" type="image/x-icon" href="https://pbs.twimg.com/profile_images/1960719102932344837/T8Sl7V0i_400x400.jpg">
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "81ab0317a4f24dde96e3b68dd2b1e0e3"}'></script>
  </head>
  <body>
    <h1>0xc4t Notes</h1>
    <p class="slogan">
      <i>Web Security &amp; Active Directory Security</i>
    </p>
    <nav>
      <a href="https://0xc4t.github.io/index.html">Posts</a>
    </nav>
    <hr>
    <div id="content" class="content"><h2>ESC2 ADCS Misconfigurations exploitation — Active Directory Pentesting</h2>
<p>ESC2 (Escalation Path 2) is a vulnerability in Active Directory Certificate Services where a certificate template allows low-privileged users to enroll and include dangerous Extended Key Usages (EKUs)</p>
<p>Examples include the following:</p>
<ul>
<li>Client Authentication (1.3.6.1.5.5.7.3.2)</li>
<li>Smart Card Logon (1.3.6.1.4.1.311.20.2.2)</li>
<li>Any Purpose (2.5.29.37.0)</li>
<li>These EKUs allow an attacker to request a certificate and authenticate as a different user via Kerberos (PKINIT), completely bypassing passwords.</li>
</ul>
<p>This attack abuses a misconfiguration in the Extended Key Usages (EKUs) of certificate templates — specifically templates that allow “Client Authentication” or “Any Purpose” — and together this enables Kerberos authentication via PKINIT.</p>
<p>For enumeration and exploitation we can use built-in Kali Linux tools:</p>
<p>Evil-WinRM, Impacket, Certipy-AD, Metasploit
ESC2 does not require password cracking or stealing password hashes, nor brute force; an attacker can easily enroll a certificate and log in without going through MFA or the domain’s password complexity policies.</p>
<p>ESC2 also does not require a high-privilege account — because the certificate template is misconfigured with access for Authenticated Users or “Any Purpose”, a normal domain user account is sufficient; an attacker can exploit this misconfiguration.</p>
<p>Lab setup
To create an ESC2 lab, we need a Primary Domain Controller, so a child Domain Controller will not work. and make sure you have installed Active Directory Certificate Services (ADCS).</p>
<p><img src="1_yIEmTZGF3l5HZj5BrWjeIQ.webp" alt="alt text"></p>
<p>Open the Certificate Template Console by pressing WIN + R <code>certtmpl.msc</code> and right-click on the template named “Code Signing,” then duplicate the template and select the General tab. Name the new template, for example, “ESC2.”</p>
<hr>
<p><img src="1_jYQZZKnD30ORyl9V2OMILA.webp" alt="alt text"></p>
<p><img src="1_btyhQC-dAEHHYTTA5S5wOA.webp" alt="alt text"></p>
<p><img src="1_qSalGNjH9BodjWy0TSz-ow.webp" alt="alt text"></p>
<p>Select the Extensions tab, then Application Policies -&gt; Edit, select Code Signing and remove it, then add Any Purpose and click OK.</p>
<hr>
<p><img src="1_TWTIeb0aBQcfOnDTXlFt4g.webp" alt="alt text"></p>
<p><img src="1_2KC0AngRe2UEbdzlZOQZbw.webp" alt="alt text"></p>
<p><img src="1_2oLRHcOurCy8x8N1HX5-fg.webp" alt="alt text"></p>
<p>Open the Security tab, click Add -&gt; Domain User and OK. Select the domain user and grant Enroll permission.</p>
<hr>
<p><img src="1_kC2BCfJNSzuPxDfrchFu6w.webp" alt="alt text"></p>
<p><img src="1_c6HhnIWZEExBOlqTtE_AJA.webp" alt="alt text"></p>
<p>After configuration, we must first enable the Certificate Template that we just created in the “Certification Authority.” Follow these steps!</p>
<hr>
<p><img src="1_XMkxrBj8wmJHjdvQPuUO_w.webp" alt="alt text"></p>
<p><img src="1_fb2cXgtRG7OwxdR5TkGS5g.webp" alt="alt text"></p>
<p><img src="1_0C7D3gKhXET-wfJqCffTxA.webp" alt="alt text"></p>
<p>And we successfully created a Certificate template that is vulnerable to ESC2! Let’s try to exploit this misconfiguration.</p>
<hr>
<h3>Enumeration and Exploitation</h3>
<p>Certipy is one of the tools that can be used for enumeration on ADCS to find vulnerable certificate templates.</p>
<p>To perform enumeration or identify vulnerable templates, we must obtain a domain user account through any initial access technique, as long as there are valid credentials to log in as a Domain User.</p>
<pre><code class="language-bash">certipy-ad find -u 'elena.doe@sandbox.local' -p P@ssw0rd -dc-ip 10.100.150.10 -vulnerable -enabled
</code></pre>
<p><img src="1_uxz1SBBbSGgffki8v4lytg.webp" alt="alt text"></p>
<p><img src="1_ZythMrGUkbNgjfR02vaHFw.webp" alt="alt text"></p>
<p><img src="1__e5PKEQFEHi_LWUtf_htDw.webp" alt="alt text"></p>
<h3>Request Certificate for Administrator</h3>
<pre><code class="language-bash">certipy-ad req -u 'elena.doe@sandbox.local' -p 'P@ssw0rd' -dc-ip 10.100.150.10 -ca sandbox-DC01-CA -target 'sandbox.local' -template 'ESC2'
</code></pre>
<p><img src="1_WMaw8ipMdNBtsrDT4bd2CQ.webp" alt="alt text"></p>
<p>If successful, we will obtain an Administrator Certificate without credentials.</p>
<p><img src="1_8oxtW9huwVRIiiNe18_Lqg.webp" alt="alt text"></p>
<p>Use the certificate from the administrator to dump NTLM hashes from the DC or Domain Controller.</p>
<p><img src="1_8dmK6s_hyZ0WCbegsSLt1A.webp" alt="alt text"></p>
<p>We successfully obtained the NTLM hash from the administrator and can use it for Pass The Hash to services on the Domain Controller such as winrm, rdp, samba, and other services.</p>
<p>Thank you for reading from start to finish. That concludes this article. Love you all!</p>
<p>Reference</p>
<ul>
<li>https://www.hackingarticles.in/ad-certificate-exploitation-esc2/</li>
<li>https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/adcs/esc2</li>
<li>https://www.vaadata.com/blog/ad-cs-security-understanding-and-exploiting-esc-techniques/</li>
</ul>
</div>

    <div class="social-icons">
      <a href="https://www.instagram.com/0xc4t?utm_source=ig_web_button_share_sheet&amp;igsh=ZDNlZDc0MzIxNw==" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://x.com/iamvarel" target="_blank"><i class="fab fa-x-twitter"></i></a>
    </div>
    <div class="footer">
      © 2025 0xc4t
    </div>


</body></html>
