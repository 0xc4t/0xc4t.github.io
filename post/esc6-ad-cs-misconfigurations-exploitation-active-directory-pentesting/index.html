<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD CS Attack Paths Series - ESC6 ADCS Misconfigurations</title>
    <link rel="icon" type="image/x-icon" href="https://pbs.twimg.com/profile_images/1994005089552580608/T5fml0FV_400x400.jpg">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AD CS Attack Paths Series - ESC6 ADCS Misconfigurations">
    <meta property="og:description" content="ESC6 is one of the exploitation paths in ADCS. It occurs when the Certificate Authority allows certificate requesters (clients) to write their own Subject Alternative Name (SAN). So, what exactly is SAN? The Subject Alternative Name is an additional identity field aside from the main subject. It can contain values like a UPN, email address, DNS name, GUID, and more.">
    <meta property="og:site_name" content="./0xc4t.re">
    <meta property="og:image" content="https://cdn-images-1.medium.com/max/800/1*poLWsUFOmkTkebbVwnOhKw.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <link rel="stylesheet" href="../../style.css">
  </head>
  <body>
    <h1>./0xc4t.re</h1>
    <p class="slogan"><i>Web Security &amp; Active Directory Security</i></p>
    <nav><a href="/">Posts</a></nav>
    <hr>
    <div id="content" class="content"><h2>ESC6 ADCS Misconfigurations exploitation — Active Directory Pentesting</h2>
<p>Since we already discussed how to exploit ESC5, let’s move on to the next one — ESC6. Honestly, this is my first time trying ESC6 as well, because even when playing on HackTheBox, I’ve never encountered it before. So if I explain something incorrectly, feel free to DM me on Instagram (@0xc4t). Alright, let’s get straight into the discussion: what exactly is ESC6?</p>
<h3>What is ESC6</h3>
<p>ESC6 is one of the exploitation paths in ADCS. It occurs when the Certificate Authority allows certificate requesters (clients) to write their own Subject Alternative Name (SAN). So, what exactly is SAN? The Subject Alternative Name is an additional identity field aside from the main subject. It can contain values like a UPN, email address, DNS name, GUID, and more.</p>
<p>The issue is that, in Active Directory, authentication relies more on the SAN than on the subject itself. This means that if a regular user is allowed to specify a UPN such as <strong>administrator@sandbox.local</strong> in the SAN field, the CA will issue a certificate claiming to be the Administrator.</p>
<p>The dangerous part is that the generated certificate becomes <strong>valid, legitimate, and trusted by the domain</strong>, allowing the attacker to impersonate high-privileged accounts.</p>
<p>So why does Windows allow the SAN field to be customized in the first place? It’s because there are certain business scenarios where custom SAN values are required — for example, applications that depend on specific SAN entries, or situations where a UPN needs to be manually overridden. Microsoft provides the option to enable <strong>“Allow SAN”</strong> so administrators can turn it on for specific environments. Under normal circumstances, this option is disabled.</p>
<p>The problem is that many administrators unknowingly enable this flag without understanding the security risks behind it.</p>
<h3>How ESC6 works ?</h3>
<p>The attacker then creates a Certificate Signing Request (CSR), and inside that CSR they insert a malicious SAN value for example, the Administrator’s UPN administrator@sandbox.local.</p>
<p>If you're using Certipy, the command typically looks like this:</p>
<pre><code class="language-bash">certipy req -u user -p pass -ca lab-CA -template User -upn administrator@domain.local
</code></pre>
<p>After that, the CA reads the user certificate template — including the EKUs, the template ACL, and the CA settings (specifically whether SAN editing is allowed). The CA Policy Engine checks the flag, and if <strong><code>EDITF_ATTRIBUTESUBJECTALTNAME2 = 1</code></strong>, the CA will <em>not</em> remove, validate, or reject the custom SAN injected by the attacker.</p>
<p>When the CA signs the certificate using its private key, the Domain Controller will trust the SAN value. The attacker can then use this certificate to authenticate via <strong>PKINIT</strong>. The DC will read the SAN → extract the UPN → match it to an AD user → and then issue a TGT for the account specified in the SAN — in this case, <strong>administrator@sandbox.local</strong>.</p>
<p>Alright, so that’s the theory. From this point, I realized I need to dive even deeper into Active Directory, because honestly, there are still parts that I don’t fully understand. I’m writing this article as my personal note — something I can refer back to if I ever encounter the same case again.</p>
<p>So, with that in mind, let’s set up the lab!</p>
<h3>Lab Setup</h3>
<p>Turn off cert services</p>
<pre><code class="language-bash">net stop certsvc
</code></pre>
<p>Modify Resgitry Settings</p>
<pre><code>certutil -setreg policyEditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
</code></pre>
<p>Start cert services</p>
<pre><code>net start certsvc
</code></pre>
<p><img alt="" src="1_poLWsUFOmkTkebbVwnOhKw.png"></p>
<p>Once everything is set up, create a new certificate template using <strong>certtmpl.msc</strong>. After that, follow the step on my article : </p>
<p><a href="https://0xc4t.re/post/esc1-ad-cs-misconfigurations-exploitation-active-airectory-pentesting/">https://0xc4t.re/post/esc1-ad-cs-misconfigurations-exploitation-active-airectory-pentesting/</a> </p>
<hr>
<h3>Enumeration &amp; Exploitation With Certipy</h3>
<p>Enumerate the certificate templates using <strong>Certipy</strong>. You can follow the command below:</p>
<pre><code>certipy find -u 'alex.doe@sandbox.local' -p "MyPassword123" -dc-ip 10.100.150.10 -vulnerable -enabled
</code></pre>
<p><img alt="" src="1_knwthdbfQn0EwfqouzbZEA.png"></p>
<p>From the Certipy results, no ESC6 misconfiguration was detected. However, because the exploitation method is similar to ESC1, Certipy still flags the vulnerability as <strong>ESC1</strong>.</p>
<p><img alt="" src="1_yxZiiO8-sLHPXfc1zfqyzw.png"></p>
<p>However, you can directly request a certificate to obtain one that impersonates the Domain Admin account (administrator@sandbox.local) and perform the takeover.</p>
<pre><code class="language-bash">certipy req -u 'alex.doe@sandbox.local' -p 'MyPassword123' -target 10.100.150.10 -ca sandbox-dc -template User -upn administrator@sandbox.local -dc-ip 10.100.150.10 -debug
</code></pre>
<p><img alt="" src="1_a8jkgmyE0-V594rVpsGngA.png"></p>
<p>And from there, we’ll obtain a <strong>.pfx</strong> file that can be used to extract the NT hash of the Administrator account. This hash can then be leveraged for further lateral movement within the environment.</p>
<p><img alt="" src="1_ZX5PPh1dyj3yMK27NsYE8A.png"></p>
<p>And once you obtain the Administrator’s NT hash, you effectively become a Domain Admin on <strong>DC01</strong>. That’s it!</p>
<p>Thank you to everyone who took the time to read my article (well… if you actually made it this far, haha). If there’s anything I explained incorrectly, feel free to DM me on Instagram <strong>(@0xc4t)</strong>.</p>
<h3>Reference</h3>
<ul>
<li><a href="https://0xc4t.re/post/esc1-ad-cs-misconfigurations-exploitation-active-airectory-pentesting/">https://0xc4t.re/post/esc1-ad-cs-misconfigurations-exploitation-active-airectory-pentesting/</a></li>
<li><a href="https://specterops.io/blog/2024/09/11/adcs-attack-paths-in-bloodhound-part-3/">https://specterops.io/blog/2024/09/11/adcs-attack-paths-in-bloodhound-part-3/</a></li>
<li><a href="https://specterops.io/blog/2021/06/17/certified-pre-owned/">https://specterops.io/blog/2021/06/17/certified-pre-owned/</a></li>
<li><a href="https://www.hackingarticles.in/esc6-editf_attributesubjectaltname2/">https://www.hackingarticles.in/esc6-editf_attributesubjectaltname2/</a></li>
</ul></div>
    <div class="social-icons">
      <a href="https://www.instagram.com/0xc4t" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://x.com/0x0c4t" target="_blank"><i class="fab fa-x-twitter"></i></a>
    </div>
    <div class="footer">© 2025 0xc4t</div>


</body></html>
